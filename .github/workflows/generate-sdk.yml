name: Generate SDK from OpenAPI Spec

on:
  repository_dispatch:
    types: [spec-updated]
  workflow_dispatch:
    inputs:
      spec_url:
        description: 'OpenAPI spec URL'
        required: false
        default: 'https://raw.githubusercontent.com/netnodes/doorguard/master/openapi.yaml'

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      COMMIT_SHA: ${{ github.event.client_payload.commit_sha || 'master' }}
      COMMIT_MESSAGE: ${{ github.event.client_payload.commit_message || 'Manual update' }}
      PUSHER_NAME: ${{ github.event.client_payload.pusher_name || github.actor }}
      SPEC_URL: ${{ github.event.client_payload.spec_url || inputs.spec_url || 'https://raw.githubusercontent.com/netnodes/doorguard/master/openapi.yaml' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch OpenAPI spec
        run: |
          echo "Fetching spec from: $SPEC_URL"
          curl -fsSL "$SPEC_URL" -o openapi.yaml

          # Validate spec downloaded
          if [ ! -s openapi.yaml ]; then
            echo "Error: Failed to download OpenAPI spec"
            exit 1
          fi

          echo "âœ… OpenAPI spec downloaded successfully"

      - name: Read current version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION="1.0.0"
          fi
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Backup custom code
        run: |
          # These directories contain hand-written code that should not be overwritten
          echo "ðŸ“¦ Backing up custom code..."
          mkdir -p /tmp/sdk-backup

          # Backup custom directories
          [ -d src/auth ] && cp -r src/auth /tmp/sdk-backup/
          [ -d src/client ] && cp -r src/client /tmp/sdk-backup/
          [ -d src/storage ] && cp -r src/storage /tmp/sdk-backup/
          [ -d src/webhooks ] && cp -r src/webhooks /tmp/sdk-backup/

          # Backup custom files
          [ -f src/index.ts ] && cp src/index.ts /tmp/sdk-backup/

          echo "âœ… Custom code backed up"
          ls -la /tmp/sdk-backup/

      - name: Generate TypeScript SDK
        run: |
          docker run --rm \
            -v ${PWD}:/local \
            openapitools/openapi-generator-cli:latest generate \
            -i /local/openapi.yaml \
            -g typescript-fetch \
            -o /local \
            -c /local/.openapi-generator-config.yaml \
            --additional-properties=npmVersion=${{ steps.version.outputs.current }}

          # Set permissions on generated files
          sudo chown -R $(id -u):$(id -g) .

          echo "âœ… SDK generated successfully"

      - name: Restore custom code
        run: |
          # Restore hand-written code that was backed up
          echo "ðŸ“¦ Restoring custom code..."

          # Restore custom directories
          [ -d /tmp/sdk-backup/auth ] && cp -r /tmp/sdk-backup/auth src/
          [ -d /tmp/sdk-backup/client ] && cp -r /tmp/sdk-backup/client src/
          [ -d /tmp/sdk-backup/storage ] && cp -r /tmp/sdk-backup/storage src/
          [ -d /tmp/sdk-backup/webhooks ] && cp -r /tmp/sdk-backup/webhooks src/

          # Restore custom index.ts (preserves our exports)
          [ -f /tmp/sdk-backup/index.ts ] && cp /tmp/sdk-backup/index.ts src/

          echo "âœ… Custom code restored"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build SDK
        run: |
          npm install
          npm run build
        continue-on-error: true
        id: build

      - name: Check for changes
        id: changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are any changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          fi

      - name: Prepare PR description
        if: steps.changes.outputs.has_changes == 'true'
        id: pr_body
        run: |
          # Sanitize commit message for PR body (remove potential injection characters)
          SAFE_MESSAGE=$(echo "$COMMIT_MESSAGE" | head -c 500 | tr -d '`$')
          SAFE_PUSHER=$(echo "$PUSHER_NAME" | head -c 100 | tr -d '`$')

          cat > pr_body.md << 'PREOF'
          ## ðŸ¤– Auto-generated SDK Update

          This PR was automatically generated in response to OpenAPI spec changes in doorguard.

          **Note:** Custom code in `src/auth`, `src/client`, `src/storage`, `src/webhooks` was preserved.

          ### Source Information
          PREOF

          echo "- **Commit SHA**: \`$COMMIT_SHA\`" >> pr_body.md
          echo "- **Triggered by**: $SAFE_PUSHER" >> pr_body.md
          echo "" >> pr_body.md
          echo "### Changes in doorguard" >> pr_body.md
          echo "\`\`\`" >> pr_body.md
          echo "$SAFE_MESSAGE" >> pr_body.md
          echo "\`\`\`" >> pr_body.md

          cat >> pr_body.md << 'PREOF'

          ### Review Checklist
          - [ ] Generated code compiles and runs
          - [ ] Build passes (check CI)
          - [ ] No breaking changes (or documented if present)
          - [ ] Version bump appropriate

          PREOF

          if [ "${{ steps.build.outcome }}" = "success" ]; then
            echo "### Build Results" >> pr_body.md
            echo "âœ… Build passed" >> pr_body.md
          else
            echo "### Build Results" >> pr_body.md
            echo "âš ï¸ Build failed - review required" >> pr_body.md
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update SDK from doorguard OpenAPI spec"
          branch: auto-update/spec-${{ github.run_id }}
          delete-branch: true
          title: "Update SDK from latest OpenAPI spec"
          body-path: pr_body.md
          labels: |
            auto-generated
            dependencies
            sdk-update

      - name: Log summary
        if: always()
        run: |
          echo "### SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes**: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ steps.build.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Protected Directories" >> $GITHUB_STEP_SUMMARY
          echo "The following custom code was preserved:" >> $GITHUB_STEP_SUMMARY
          echo "- \`src/auth/\` - OAuth authentication" >> $GITHUB_STEP_SUMMARY
          echo "- \`src/client/\` - DoorFlow client" >> $GITHUB_STEP_SUMMARY
          echo "- \`src/storage/\` - Token storage" >> $GITHUB_STEP_SUMMARY
          echo "- \`src/webhooks/\` - Webhook handling" >> $GITHUB_STEP_SUMMARY
